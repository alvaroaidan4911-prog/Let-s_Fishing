<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no,viewport-fit=cover">
<title>Let's Fishing! v4</title>
<link rel="manifest" href="manifest.json">
<style>
*{box-sizing:border-box;-webkit-tap-highlight-color:transparent;}
html,body{margin:0;padding:0;overflow:hidden;background:#000;touch-action:none;font-family:'Segoe UI',Arial,sans-serif;}
canvas{display:block;}

/* â”€â”€ LOADING â”€â”€ */
#loadingScreen{position:fixed;inset:0;background:linear-gradient(135deg,#0a1628,#1a3a5c);display:flex;flex-direction:column;justify-content:center;align-items:center;z-index:9999;color:#fff;}
#gameIcon{width:110px;height:110px;margin-bottom:16px;border-radius:20px;box-shadow:0 0 30px rgba(100,200,255,.5);}
#loadingTitle{font-size:30px;font-weight:bold;color:#7ecfff;text-shadow:0 0 20px rgba(126,207,255,.8);margin-bottom:4px;}
#loadingSubtitle{font-size:12px;color:#aaa;margin-bottom:22px;}
#loadingBarContainer{width:65%;height:14px;background:rgba(255,255,255,.1);border-radius:8px;overflow:hidden;margin-bottom:8px;border:1px solid rgba(255,255,255,.2);}
#loadingBar{width:0%;height:100%;background:linear-gradient(90deg,#3498db,#7ecfff);border-radius:8px;transition:width .1s;}
#loadingText{font-size:12px;color:#aaa;}

/* â”€â”€ JOYSTICK â”€â”€ */
#joystick{position:absolute;bottom:35px;left:25px;width:120px;height:120px;border-radius:50%;background:rgba(255,255,255,.13);border:2px solid rgba(255,255,255,.28);touch-action:none;z-index:10;}
#stick{position:absolute;width:48px;height:48px;background:rgba(255,255,255,.72);border-radius:50%;left:36px;top:36px;box-shadow:0 2px 8px rgba(0,0,0,.4);transition:left .05s,top .05s;}

/* â”€â”€ HUD TOP â”€â”€ */
#coinUI{position:fixed;left:12px;top:14px;color:#fff;font-size:16px;font-weight:bold;background:rgba(0,0,0,.62);backdrop-filter:blur(6px);padding:7px 13px;border-radius:11px;z-index:20;border:1px solid rgba(255,255,255,.1);}
#levelUI{position:fixed;left:12px;top:56px;color:#fff;font-size:12px;font-weight:bold;background:rgba(0,0,0,.62);backdrop-filter:blur(6px);padding:7px 13px;border-radius:11px;z-index:20;border:1px solid rgba(255,255,255,.1);min-width:170px;}
#xpBarContainer{width:100%;height:5px;background:rgba(255,255,255,.18);border-radius:3px;margin-top:5px;overflow:hidden;}
#xpBar{height:100%;width:0%;background:linear-gradient(90deg,#f39c12,#f1c40f);border-radius:3px;transition:width .4s;}
#weatherUI{position:fixed;right:12px;top:14px;color:#fff;font-size:12px;background:rgba(0,0,0,.62);backdrop-filter:blur(6px);padding:7px 12px;border-radius:11px;z-index:20;border:1px solid rgba(255,255,255,.1);}

/* â”€â”€ FISHING TENSION BAR â”€â”€ */
#tensionContainer{position:fixed;bottom:190px;left:50%;transform:translateX(-50%);width:260px;display:none;flex-direction:column;align-items:center;gap:5px;z-index:50;}
#tensionLabel{color:#fff;font-size:13px;font-weight:bold;text-shadow:0 1px 4px rgba(0,0,0,.8);}
#tensionTrack{width:100%;height:22px;background:rgba(0,0,0,.5);border-radius:11px;border:2px solid rgba(255,255,255,.25);overflow:hidden;position:relative;}
#tensionBar{height:100%;width:50%;border-radius:9px;transition:background .2s;position:relative;}
#tensionZone{position:absolute;top:0;height:100%;background:rgba(255,255,255,.22);border-radius:4px;pointer-events:none;}
#tensionIndicator{position:absolute;top:-2px;width:8px;height:26px;background:#fff;border-radius:4px;transform:translateX(-50%);box-shadow:0 0 8px #fff;pointer-events:none;}
#reelBtn{padding:10px 28px;background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;border:none;border-radius:20px;font-size:15px;font-weight:bold;cursor:pointer;box-shadow:0 4px 14px rgba(231,76,60,.5);touch-action:none;}
#reelBtn:active{transform:scale(.95);}
#catchPrompt{color:#2ecc71;font-size:12px;font-weight:bold;text-shadow:0 0 8px rgba(46,204,113,.8);display:none;}

/* â”€â”€ BITE ICON â”€â”€ */
#biteIcon{position:fixed;top:34%;left:50%;transform:translate(-50%,-50%);font-size:56px;display:none;animation:popAnim .4s infinite alternate;z-index:50;pointer-events:none;}
@keyframes popAnim{from{transform:translate(-50%,-50%) scale(1)}to{transform:translate(-50%,-50%) scale(1.25)}}

/* â”€â”€ NOTIFICATIONS â”€â”€ */
#fishNotify{position:fixed;top:88px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.88);color:#fff;padding:10px 20px;border-radius:13px;font-size:16px;display:none;z-index:100;border:1px solid rgba(255,255,255,.2);white-space:nowrap;}
#eventNotify{position:fixed;top:155px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.88);color:#f1c40f;padding:9px 18px;border-radius:13px;font-size:14px;display:none;z-index:100;border:1px solid rgba(241,196,15,.3);white-space:nowrap;}
#xpNotify{position:fixed;top:40%;left:50%;transform:translate(-50%,-50%);color:#f1c40f;font-size:28px;font-weight:bold;display:none;z-index:200;text-shadow:0 0 20px rgba(241,196,15,.9);pointer-events:none;}
@keyframes xpFloat{0%{opacity:0;transform:translate(-50%,-50%) scale(.5)}20%{opacity:1;transform:translate(-50%,-62%) scale(1.1)}80%{opacity:1}100%{opacity:0;transform:translate(-50%,-85%)}}

/* â”€â”€ JETSKI HUD â”€â”€ */
#jetskiUI{position:fixed;right:12px;bottom:160px;background:rgba(0,0,0,.72);backdrop-filter:blur(6px);padding:9px 14px;border-radius:11px;z-index:20;border:1px solid rgba(231,76,60,.4);display:none;color:#fff;text-align:center;}
#jetskiSpeed{font-size:20px;font-weight:bold;color:#e74c3c;}
.jsLabel{font-size:10px;color:#aaa;}

/* â”€â”€ INVENTORY â”€â”€ */
#inventoryBtn{position:fixed;right:12px;bottom:110px;width:48px;height:48px;background:rgba(0,0,0,.7);border:2px solid rgba(255,255,255,.25);border-radius:12px;font-size:22px;display:flex;align-items:center;justify-content:center;cursor:pointer;z-index:20;}
#inventoryUI{position:fixed;inset:0;background:rgba(0,0,0,.88);backdrop-filter:blur(8px);z-index:3000;display:none;flex-direction:column;overflow:hidden;}
#invHeader{display:flex;align-items:center;justify-content:space-between;padding:14px 18px;border-bottom:1px solid rgba(255,255,255,.1);}
#invHeader h2{margin:0;color:#7ecfff;font-size:18px;}
#invCloseBtn{background:rgba(255,255,255,.1);border:1px solid rgba(255,255,255,.2);color:#fff;padding:7px 16px;border-radius:9px;cursor:pointer;font-size:13px;}
#invTabs{display:flex;gap:0;border-bottom:1px solid rgba(255,255,255,.1);}
.invTab{flex:1;padding:10px;text-align:center;cursor:pointer;font-size:13px;color:#aaa;border-bottom:3px solid transparent;transition:all .2s;}
.invTab.active{color:#7ecfff;border-bottom-color:#7ecfff;background:rgba(126,207,255,.06);}
#invContent{flex:1;overflow-y:auto;padding:14px;}

/* ROD PANEL */
.rodRow{display:flex;align-items:center;gap:12px;padding:12px;background:rgba(255,255,255,.05);border-radius:12px;margin-bottom:8px;border:2px solid transparent;cursor:pointer;transition:all .2s;}
.rodRow.equipped{border-color:#f1c40f;background:rgba(241,196,15,.08);}
.rodRow:hover{background:rgba(255,255,255,.1);}
.rodIcon{font-size:32px;width:44px;text-align:center;}
.rodInfo{flex:1;}
.rodInfo h4{margin:0 0 3px;color:#fff;font-size:14px;}
.rodInfo p{margin:0;font-size:11px;color:#aaa;}
.rodInfo .rodStats{font-size:11px;color:#7ecfff;margin-top:3px;}
.rodEquipBtn{padding:7px 14px;border:none;border-radius:8px;cursor:pointer;font-size:12px;font-weight:bold;}
.rodEquipBtn.eq{background:rgba(241,196,15,.25);color:#f1c40f;}
.rodEquipBtn.neq{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;}

/* BAIT PANEL */
.baitGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(130px,1fr));gap:10px;}
.baitCard{background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.12);border-radius:12px;padding:12px;text-align:center;cursor:pointer;transition:all .2s;}
.baitCard.selected{border-color:#2ecc71;background:rgba(46,204,113,.1);}
.baitCard:hover{background:rgba(255,255,255,.1);}
.baitCard .baitIcon{font-size:36px;margin-bottom:6px;}
.baitCard h4{margin:0 0 3px;font-size:13px;color:#fff;}
.baitCard p{margin:0;font-size:10px;color:#aaa;}
.baitCard .baitCount{display:inline-block;background:rgba(0,0,0,.4);border-radius:6px;padding:2px 8px;font-size:11px;color:#7ecfff;margin-top:5px;}

/* FISH BAG */
.fishBagGrid{display:grid;grid-template-columns:repeat(auto-fill,minmax(110px,1fr));gap:10px;}
.fishCard{background:rgba(255,255,255,.05);border:1px solid rgba(255,255,255,.12);border-radius:12px;padding:10px;text-align:center;position:relative;transition:all .2s;}
.fishCard.holding{border-color:#f1c40f;background:rgba(241,196,15,.1);}
.fishCard .fishIcon{font-size:32px;margin-bottom:5px;}
.fishCard h4{margin:0 0 2px;font-size:12px;color:#fff;}
.fishCard .fishRar{font-size:10px;margin-bottom:4px;}
.fishCard .fishPrice{font-size:11px;color:#f1c40f;}
.holdBtn{margin-top:6px;width:100%;padding:5px;border:none;border-radius:7px;cursor:pointer;font-size:11px;font-weight:bold;}
.holdBtn.hold{background:linear-gradient(135deg,#f39c12,#e67e22);color:#fff;}
.holdBtn.unhold{background:rgba(255,255,255,.1);color:#fff;}

/* BUY ROD SHOP in Inventory */
.buyRodBtn{padding:6px 12px;background:linear-gradient(135deg,#8e44ad,#9b59b6);color:#fff;border:none;border-radius:7px;cursor:pointer;font-size:11px;}
.buyRodBtn.owned{background:rgba(39,174,96,.3);color:#2ecc71;cursor:default;}
#invSellAllBtn{width:100%;padding:12px;background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;border:none;border-radius:12px;font-size:15px;font-weight:bold;cursor:pointer;margin-top:10px;}

/* â”€â”€ HELD FISH HUD â”€â”€ */
#heldFishHUD{position:fixed;bottom:170px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.75);border:1px solid rgba(255,255,255,.2);border-radius:12px;padding:8px 14px;color:#fff;font-size:13px;z-index:20;display:none;white-space:nowrap;}

/* â”€â”€ WORLD BUTTONS â”€â”€ */
.worldBtn{position:absolute;padding:10px 16px;color:#fff;border-radius:11px;display:none;z-index:999;border:none;cursor:pointer;font-size:13px;font-weight:bold;white-space:nowrap;box-shadow:0 3px 12px rgba(0,0,0,.4);}
#sellBtn{background:linear-gradient(135deg,#27ae60,#2ecc71);}
#openRodShopBtn{background:linear-gradient(135deg,#8e44ad,#9b59b6);}
#openJetskiShopBtn{background:linear-gradient(135deg,#e67e22,#f39c12);}
#mountJetskiBtn{position:absolute;padding:10px 18px;background:linear-gradient(135deg,#e74c3c,#c0392b);color:#fff;border-radius:11px;display:none;z-index:999;border:none;cursor:pointer;font-size:13px;font-weight:bold;}
#interactHint{position:fixed;bottom:170px;left:50%;transform:translateX(-50%);background:rgba(0,0,0,.65);color:rgba(255,255,255,.8);font-size:11px;padding:5px 12px;border-radius:8px;z-index:15;pointer-events:none;display:none;white-space:nowrap;}

/* â”€â”€ MENU â”€â”€ */
#openMenuBtn{position:absolute;top:14px;right:14px;padding:9px 14px;background:rgba(0,0,0,.62);color:#fff;border-radius:10px;z-index:1000;border:1px solid rgba(255,255,255,.18);cursor:pointer;font-size:13px;}
#menuUI{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);display:none;flex-direction:column;gap:10px;background:rgba(0,0,0,.96);padding:28px;border-radius:16px;z-index:4000;min-width:210px;border:1px solid rgba(255,255,255,.1);}
#menuUI h2{color:#fff;text-align:center;margin:0 0 10px;font-size:20px;}
#menuUI button{padding:11px;background:rgba(255,255,255,.09);color:#fff;border:1px solid rgba(255,255,255,.18);border-radius:10px;cursor:pointer;font-size:14px;}
#menuUI #resumeBtn{background:linear-gradient(135deg,#27ae60,#2ecc71);border:none;}
#menuUI #quitBtn{background:linear-gradient(135deg,#c0392b,#e74c3c);border:none;}
#customUI{display:none;position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);background:rgba(0,0,0,.96);padding:24px;border-radius:16px;color:#fff;z-index:5000;min-width:250px;border:1px solid rgba(255,255,255,.1);}
#customUI h3{margin:0 0 14px;text-align:center;}
#customUI label{font-size:12px;color:#aaa;display:block;margin-bottom:4px;}
#customUI input[type=color]{width:100%;height:38px;border:none;border-radius:8px;cursor:pointer;margin-bottom:13px;}
#customUI button{width:100%;padding:10px;border:none;border-radius:8px;cursor:pointer;font-size:13px;margin-bottom:7px;}
#saveCustom{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;}
#closeCustomBtn{background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2)!important;}

/* â”€â”€ JETSKI SHOP UI â”€â”€ */
#jetskiShopUI{position:absolute;top:50%;left:50%;transform:translate(-50%,-50%);width:min(88vw,500px);max-height:85vh;background:rgba(5,15,30,.97);padding:22px;border-radius:18px;display:none;flex-direction:column;gap:14px;overflow-y:auto;z-index:1200;color:#fff;border:1px solid rgba(100,180,255,.2);}
#jetskiShopUI h2{text-align:center;margin:0 0 4px;font-size:20px;color:#7ecfff;}
.jsShopCard{background:rgba(255,255,255,.05);border:1px solid rgba(231,76,60,.3);border-radius:14px;padding:16px;text-align:center;}
.jsShopCard .bigIcon{font-size:64px;margin-bottom:8px;}
.jsShopCard h3{margin:0 0 6px;color:#e74c3c;}
.jsShopCard p{margin:0 0 8px;font-size:12px;color:#aaa;}
.jsShopCard button{padding:10px 24px;background:linear-gradient(135deg,#e67e22,#f39c12);color:#fff;border:none;border-radius:10px;cursor:pointer;font-size:14px;font-weight:bold;}

/* â”€â”€ HOTBAR â”€â”€ */
#hotbar{position:fixed;bottom:18px;left:50%;transform:translateX(-50%);display:flex;gap:10px;z-index:10;}
.slot{width:58px;height:58px;background:rgba(0,0,0,.5);border:3px solid rgba(255,255,255,.38);border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:26px;color:#fff;cursor:pointer;}
.slot.active{border-color:#f1c40f;background:rgba(241,196,15,.18);}

/* â”€â”€ SCROLL BARS â”€â”€ */
::-webkit-scrollbar{width:4px;} ::-webkit-scrollbar-track{background:rgba(255,255,255,.05);} ::-webkit-scrollbar-thumb{background:rgba(255,255,255,.2);border-radius:4px;}

/* â”€â”€ MAIN MENU â”€â”€ */
#mainMenu{position:fixed;inset:0;background:linear-gradient(160deg,#030d1a 0%,#071a35 50%,#0a2a50 100%);display:none;flex-direction:column;justify-content:center;align-items:center;z-index:9998;color:#fff;overflow:hidden;}
#mainMenu.show{display:flex;}
#mainMenuBg{position:absolute;inset:0;pointer-events:none;overflow:hidden;}
.menuStar{position:absolute;border-radius:50%;background:#fff;animation:twinkle 2s infinite alternate;}
@keyframes twinkle{0%{opacity:0.2;transform:scale(1);}100%{opacity:1;transform:scale(1.3);}}
#mainMenuLogo{position:relative;text-align:center;margin-bottom:36px;}
#mainMenuLogo .logoIcon{font-size:72px;display:block;filter:drop-shadow(0 0 20px rgba(100,200,255,0.8));}
#mainMenuLogo h1{font-size:38px;font-weight:900;margin:8px 0 0;background:linear-gradient(90deg,#7ecfff,#fff,#7ecfff);-webkit-background-clip:text;-webkit-text-fill-color:transparent;text-shadow:none;letter-spacing:2px;}
#mainMenuLogo p{font-size:12px;color:#7ecfff;opacity:0.7;margin:4px 0 0;letter-spacing:3px;}
#mainMenuBtns{display:flex;flex-direction:column;gap:14px;width:280px;position:relative;}
.menuBtn{width:100%;padding:16px 0;border:none;border-radius:16px;font-size:17px;font-weight:700;cursor:pointer;letter-spacing:0.5px;transition:all 0.18s;display:flex;align-items:center;justify-content:center;gap:10px;position:relative;overflow:hidden;}
.menuBtn::after{content:'';position:absolute;inset:0;background:rgba(255,255,255,0);transition:background 0.15s;}
.menuBtn:active::after{background:rgba(255,255,255,0.15);}
.menuBtn:active{transform:scale(0.97);}
#btnSingle{background:linear-gradient(135deg,#2980b9,#3498db);color:#fff;box-shadow:0 6px 20px rgba(52,152,219,0.45);}
#btnMulti{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;box-shadow:0 6px 20px rgba(46,204,113,0.45);}
#btnSettings{background:linear-gradient(135deg,#7f8c8d,#95a5a6);color:#fff;box-shadow:0 6px 20px rgba(127,140,141,0.4);}
#btnQuit{background:linear-gradient(135deg,#922b21,#e74c3c);color:#fff;box-shadow:0 6px 20px rgba(231,76,60,0.4);}
#mainMenuVersion{position:relative;margin-top:28px;font-size:11px;color:rgba(126,207,255,0.5);letter-spacing:2px;}

/* â”€â”€ SINGLEPLAYER MENU â”€â”€ */
#spMenu{position:fixed;inset:0;background:linear-gradient(160deg,#030d1a,#071a35);display:none;flex-direction:column;justify-content:center;align-items:center;z-index:9997;color:#fff;}
#spMenu.show{display:flex;}
.subMenuTitle{font-size:24px;font-weight:800;margin-bottom:28px;color:#7ecfff;letter-spacing:1px;}
.subMenuCard{width:300px;background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.13);border-radius:18px;padding:22px 24px;margin-bottom:14px;cursor:pointer;transition:all 0.18s;display:flex;align-items:center;gap:16px;}
.subMenuCard:hover,.subMenuCard:active{background:rgba(255,255,255,0.13);transform:scale(1.02);}
.subMenuCardIcon{font-size:36px;}
.subMenuCardText h3{font-size:16px;font-weight:700;margin:0 0 4px;}
.subMenuCardText p{font-size:12px;color:#aaa;margin:0;}
.backBtn{margin-top:12px;padding:10px 28px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);color:#fff;border-radius:12px;font-size:14px;cursor:pointer;letter-spacing:1px;}
.backBtn:active{opacity:0.7;}

/* â”€â”€ MULTIPLAYER MENU â”€â”€ */
#mpMenu{position:fixed;inset:0;background:linear-gradient(160deg,#030d1a,#071a35);display:none;flex-direction:column;justify-content:center;align-items:center;z-index:9997;color:#fff;padding:20px;}
#mpMenu.show{display:flex;}
#mpRoomList{width:100%;max-width:340px;max-height:45vh;overflow-y:auto;margin-bottom:14px;}
.roomCard{background:rgba(255,255,255,0.07);border:1px solid rgba(255,255,255,0.13);border-radius:14px;padding:14px 18px;margin-bottom:10px;cursor:pointer;transition:all 0.15s;display:flex;justify-content:space-between;align-items:center;}
.roomCard:active{background:rgba(255,255,255,0.15);}
.roomCard .roomName{font-size:15px;font-weight:700;}
.roomCard .roomInfo{font-size:11px;color:#aaa;}
.roomCard .roomJoin{background:#27ae60;color:#fff;border:none;border-radius:8px;padding:6px 14px;font-size:13px;cursor:pointer;}
#mpCreateBtn{width:100%;max-width:340px;padding:14px;background:linear-gradient(135deg,#2980b9,#3498db);color:#fff;border:none;border-radius:14px;font-size:16px;font-weight:700;cursor:pointer;margin-bottom:10px;}
#mpRefreshBtn{width:100%;max-width:340px;padding:10px;background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2);border-radius:12px;font-size:14px;cursor:pointer;margin-bottom:10px;}

/* â”€â”€ CREATE ROOM MODAL â”€â”€ */
#createRoomModal{position:fixed;inset:0;background:rgba(0,0,0,0.85);display:none;justify-content:center;align-items:center;z-index:10000;}
#createRoomModal.show{display:flex;}
#createRoomBox{background:linear-gradient(135deg,#0a1628,#1a3a5c);border:1px solid rgba(126,207,255,0.3);border-radius:20px;padding:28px 24px;width:90%;max-width:320px;color:#fff;}
#createRoomBox h3{margin:0 0 18px;font-size:20px;color:#7ecfff;text-align:center;}
#createRoomBox input{width:100%;padding:12px 14px;background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:10px;color:#fff;font-size:15px;margin-bottom:14px;outline:none;}
#createRoomBox input::placeholder{color:#aaa;}
.modalBtns{display:flex;gap:10px;}
.modalBtns button{flex:1;padding:12px;border:none;border-radius:10px;font-size:15px;font-weight:700;cursor:pointer;}
#confirmCreateRoom{background:linear-gradient(135deg,#27ae60,#2ecc71);color:#fff;}
#cancelCreateRoom{background:rgba(255,255,255,0.15);color:#fff;}

/* â”€â”€ SETTINGS MENU (FULL) â”€â”€ */
#settingsMenu{position:fixed;inset:0;background:linear-gradient(160deg,#030d1a,#071a35);display:none;flex-direction:column;z-index:9997;color:#fff;overflow-y:auto;}
#settingsMenu.show{display:flex;}
#settingsHeader{padding:20px 20px 0;display:flex;align-items:center;gap:12px;}
#settingsHeader h2{font-size:22px;color:#7ecfff;margin:0;}
#settingsTabs{display:flex;gap:8px;padding:16px 20px 0;border-bottom:1px solid rgba(255,255,255,0.1);}
.setTab{padding:9px 18px;border:none;background:rgba(255,255,255,0.08);color:#aaa;border-radius:10px 10px 0 0;font-size:13px;cursor:pointer;font-weight:600;}
.setTab.active{background:rgba(126,207,255,0.18);color:#7ecfff;border-bottom:2px solid #7ecfff;}
#settingsContent{flex:1;padding:20px;max-width:500px;width:100%;margin:0 auto;}
.setSection{margin-bottom:22px;}
.setSection h3{font-size:14px;color:#7ecfff;margin:0 0 12px;text-transform:uppercase;letter-spacing:1px;}
.setRow{display:flex;align-items:center;justify-content:space-between;padding:12px 0;border-bottom:1px solid rgba(255,255,255,0.06);}
.setRow label{font-size:14px;color:#ddd;}
.setRow input[type=range]{width:130px;accent-color:#3498db;}
.setRow input[type=color]{width:44px;height:32px;border:none;border-radius:8px;cursor:pointer;background:none;}
.setRow select{background:rgba(255,255,255,0.1);color:#fff;border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:6px 10px;font-size:13px;}
.setToggle{width:46px;height:26px;background:rgba(255,255,255,0.2);border-radius:13px;cursor:pointer;position:relative;transition:background 0.2s;}
.setToggle.on{background:#27ae60;}
.setToggle::after{content:'';position:absolute;top:3px;left:3px;width:20px;height:20px;background:#fff;border-radius:50%;transition:left 0.2s;}
.setToggle.on::after{left:23px;}

/* â”€â”€ BROADCAST NOTIFICATION (seperti fishNotify) â”€â”€ */
#broadcastNotif{position:fixed;top:128px;left:50%;transform:translateX(-50%);background:linear-gradient(135deg,rgba(20,40,80,0.97),rgba(10,20,50,0.97));color:#fff;padding:12px 22px;border-radius:14px;font-size:14px;display:none;z-index:200;border:1px solid rgba(126,207,255,0.4);white-space:nowrap;box-shadow:0 4px 20px rgba(0,100,255,0.3);max-width:90vw;white-space:normal;text-align:center;}
#broadcastNotif .bcOwner{font-size:11px;color:#7ecfff;font-weight:700;letter-spacing:1px;margin-bottom:3px;}
#broadcastNotif .bcMsg{font-size:15px;color:#fff;font-weight:600;}
</style>
</head>
<body>

<!-- LOADING -->
<div id="loadingScreen">
  <img id="gameIcon" src="icons/icon-512.png" alt="">
  <div id="loadingTitle">ğŸ£ Let's Fishing!</div>
  <div id="loadingSubtitle">v4.0 â€” Tension Bar Â· Bait Â· Full Inventory</div>
  <div id="loadingBarContainer"><div id="loadingBar"></div></div>
  <p id="loadingText">Loading... 0%</p>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MAIN MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mainMenu">
  <div id="mainMenuBg"></div>
  <div id="mainMenuLogo">
    <span class="logoIcon">ğŸ£</span>
    <h1>Let's Fishing!</h1>
    <p>v4.0 Â· OPEN WORLD</p>
  </div>
  <div id="mainMenuBtns">
    <button class="menuBtn" id="btnSingle" onclick="showSPMenu()">ğŸï¸ Singleplayer</button>
    <button class="menuBtn" id="btnMulti" onclick="showMPMenu()">ğŸŒ Multiplayer</button>
    <button class="menuBtn" id="btnSettings" onclick="showSettingsMenu()">âš™ï¸ Settings</button>
    <button class="menuBtn" id="btnQuit" onclick="forceQuit()">ğŸšª Quit Game</button>
  </div>
  <div id="mainMenuVersion">LET'S FISHING v4.0</div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SINGLEPLAYER MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="spMenu">
  <div class="subMenuTitle">ğŸï¸ Singleplayer</div>
  <div class="subMenuCard" onclick="startNewGame()">
    <div class="subMenuCardIcon">ğŸ†•</div>
    <div class="subMenuCardText">
      <h3>New Game</h3>
      <p>Mulai petualangan baru dari awal</p>
    </div>
  </div>
  <div class="subMenuCard" onclick="loadSavedGame()">
    <div class="subMenuCardIcon">ğŸ’¾</div>
    <div class="subMenuCardText">
      <h3>Load Game</h3>
      <p id="spSaveInfo">Memuat save terakhir...</p>
    </div>
  </div>
  <button class="backBtn" onclick="showMainMenu()">â† Kembali</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• MULTIPLAYER MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="mpMenu">
  <div class="subMenuTitle">ğŸŒ Multiplayer</div>
  <div id="mpRoomList"><div style="text-align:center;color:#aaa;padding:20px;">Memuat server...</div></div>
  <button id="mpCreateBtn" onclick="showCreateRoom()">â• Buat Room Baru</button>
  <button id="mpRefreshBtn" onclick="refreshRoomList()">ğŸ”„ Refresh</button>
  <button class="backBtn" onclick="showMainMenu()">â† Kembali</button>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• CREATE ROOM MODAL â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="createRoomModal">
  <div id="createRoomBox">
    <h3>ğŸ›¥ï¸ Buat Room Baru</h3>
    <input id="roomNameInput" type="text" placeholder="Nama room (maks 24 karakter)" maxlength="24">
    <input id="playerNameInput" type="text" placeholder="Nama kamu" maxlength="16" value="">
    <div class="modalBtns">
      <button id="cancelCreateRoom" onclick="hideCreateRoom()">Batal</button>
      <button id="confirmCreateRoom" onclick="doCreateRoom()">âœ… Buat</button>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â• SETTINGS MENU â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
<div id="settingsMenu">
  <div id="settingsHeader">
    <button class="backBtn" style="margin:0" onclick="settingsBack()">â†</button>
    <h2>âš™ï¸ Settings</h2>
  </div>
  <div id="settingsTabs">
    <button class="setTab active" onclick="switchSetTab('character',this)">ğŸ‘¤ Karakter</button>
    <button class="setTab" onclick="switchSetTab('graphics',this)">ğŸ¨ Grafik</button>
    <button class="setTab" onclick="switchSetTab('sound',this)">ğŸ”Š Suara</button>
    <button class="setTab" onclick="switchSetTab('controls',this)">ğŸ•¹ï¸ Kontrol</button>
  </div>
  <div id="settingsContent">
    <!-- Character Tab -->
    <div id="setTab_character" class="setTabContent">
      <div class="setSection">
        <h3>Penampilan Karakter</h3>
        <div class="setRow"><label>ğŸ½ Warna Baju</label><input type="color" id="shirtColor2" value="#2ecc71" onchange="applyShirtColor(this.value)"></div>
        <div class="setRow"><label>ğŸ‘¤ Nama Pemain</label><input type="text" id="playerNameSet" placeholder="Nama kamu" maxlength="16" style="background:rgba(255,255,255,0.1);border:1px solid rgba(255,255,255,0.2);border-radius:8px;padding:6px 10px;color:#fff;font-size:13px;width:140px;" value=""></div>
        <div class="setRow"><label></label><button onclick="savePlayerName()" style="background:#3498db;color:#fff;border:none;border-radius:8px;padding:8px 16px;cursor:pointer;font-size:13px;">ğŸ’¾ Simpan Nama</button></div>
      </div>
    </div>
    <!-- Graphics Tab -->
    <div id="setTab_graphics" class="setTabContent" style="display:none">
      <div class="setSection">
        <h3>Kualitas Grafik</h3>
        <div class="setRow"><label>ğŸŒ«ï¸ Fog Density</label><input type="range" id="fogRange" min="0.001" max="0.02" step="0.001" value="0.004" oninput="applyFog(this.value)"></div>
        <div class="setRow"><label>ğŸ’§ Water Quality</label><select id="waterQual" onchange="applyWaterQuality(this.value)"><option value="low">Low</option><option value="medium" selected>Medium</option><option value="high">High</option></select></div>
        <div class="setRow"><label>â˜€ï¸ Shadow</label><div class="setToggle on" id="shadowToggle" onclick="toggleShadow(this)"></div></div>
        <div class="setRow"><label>ğŸ“± Pixel Ratio</label><select id="pixelRatio" onchange="applyPixelRatio(this.value)"><option value="1">Low (1x)</option><option value="1.5">Medium (1.5x)</option><option value="2" selected>High (2x)</option></select></div>
      </div>
    </div>
    <!-- Sound Tab -->
    <div id="setTab_sound" class="setTabContent" style="display:none">
      <div class="setSection">
        <h3>Volume</h3>
        <div class="setRow"><label>ğŸµ Musik</label><input type="range" id="musicVol" min="0" max="1" step="0.05" value="0.35" oninput="applyMusicVol(this.value)"></div>
        <div class="setRow"><label>ğŸ£ SFX Cast</label><input type="range" id="sfxVol" min="0" max="1" step="0.05" value="0.7" oninput="applySFXVol(this.value)"></div>
        <div class="setRow"><label>ğŸ”‡ Mute Semua</label><div class="setToggle" id="muteToggle" onclick="toggleMute(this)"></div></div>
      </div>
    </div>
    <!-- Controls Tab -->
    <div id="setTab_controls" class="setTabContent" style="display:none">
      <div class="setSection">
        <h3>Kontrol</h3>
        <div class="setRow"><label>ğŸ•¹ï¸ Joystick Size</label><input type="range" id="joySize" min="80" max="160" step="10" value="120" oninput="applyJoySize(this.value)"></div>
        <div class="setRow"><label>ğŸ“± Sensitivitas Kamera</label><input type="range" id="camSens" min="0.003" max="0.015" step="0.001" value="0.007"></div>
        <div class="setRow"><label>ğŸ”’ Lock Landscape</label><div class="setToggle on" id="landscapeToggle" onclick="toggleLandscape(this)"></div></div>
      </div>
      <div class="setSection">
        <h3>Keyboard (PC)</h3>
        <div style="color:#aaa;font-size:13px;line-height:1.8;">
          WASD / Arrow Keys â€” Gerak<br>
          F / Space â€” Cast / Reel<br>
          E â€” Naik/Turun Jetski<br>
          I â€” Buka Inventory<br>
          1-4 â€” Ganti Rod<br>
          Esc â€” Menu
        </div>
      </div>
    </div>
  </div>
</div>

<!-- BROADCAST NOTIFICATION -->
<div id="broadcastNotif">
  <div class="bcOwner">ğŸ‘‘ OWNER Â· Varz444</div>
  <div class="bcMsg" id="broadcastMsg">â€”</div>
</div>
<div id="coinUI">ğŸ’° 0</div>
<div id="levelUI">
  â­ Lv.<span id="levelNum">1</span> <span id="levelTitle">Beginner</span>
  <div id="xpBarContainer"><div id="xpBar"></div></div>
  <div id="xpText" style="font-size:10px;color:#aaa;margin-top:2px;">0/100 XP</div>
</div>
<div id="weatherUI">â˜€ï¸ Sunny</div>
<div id="jetskiUI"><div class="jsLabel">ğŸ›¥ï¸ SPEED</div><div id="jetskiSpeed">0 km/h</div><div class="jsLabel">[E] Dismount</div></div>
<div id="heldFishHUD">ğŸŸ Holding: â€”</div>

<!-- TENSION BAR (fishing) -->
<div id="tensionContainer">
  <div id="tensionLabel">ğŸ£ Keep in the ZONE!</div>
  <div id="tensionTrack">
    <div id="tensionBar"></div>
    <div id="tensionZone"></div>
    <div id="tensionIndicator"></div>
  </div>
  <button id="reelBtn">ğŸ£ REEL IN</button>
  <div id="catchPrompt">âœ… Release to CATCH!</div>
</div>

<div id="biteIcon">â—</div>
<div id="fishNotify"></div>
<div id="eventNotify"></div>
<div id="xpNotify">+XP!</div>
<div id="interactHint"></div>

<!-- CONTROLS -->
<button id="openMenuBtn">â˜°</button>
<div id="joystick"><div id="stick"></div></div>
<div id="hotbar"><div class="slot active" id="slot1">ğŸ£</div></div>

<!-- INVENTORY -->
<div id="inventoryBtn" onclick="toggleInventory()">ğŸ’</div>

<!-- WORLD BUTTONS -->
<button id="sellBtn" class="worldBtn">ğŸŸ Sell Fish</button>
<button id="openRodShopBtn" class="worldBtn">ğŸ›’ Rods</button>
<button id="openJetskiShopBtn" class="worldBtn">ğŸ›¥ï¸ Jetski</button>
<button id="mountJetskiBtn">ğŸ›¥ï¸ Mount [E]</button>

<!-- â•â•â•â•â•â•â• INVENTORY UI â•â•â•â•â•â•â• -->
<div id="inventoryUI">
  <div id="invHeader">
    <h2>ğŸ’ Inventory</h2>
    <button id="invCloseBtn" onclick="toggleInventory()">âœ• Close</button>
  </div>
  <div id="invTabs">
    <div class="invTab active" onclick="switchTab('rods')">ğŸ£ Rods</div>
    <div class="invTab" onclick="switchTab('bait')">ğŸª± Bait</div>
    <div class="invTab" onclick="switchTab('fish')">ğŸŸ Fish Bag</div>
  </div>
  <div id="invContent"></div>
</div>

<!-- JETSKI SHOP -->
<div id="jetskiShopUI">
  <h2>ğŸ›¥ï¸ Jetski Shop</h2>
  <div class="jsShopCard">
    <div class="bigIcon">ğŸ›¥ï¸</div>
    <h3>Red Jetski</h3>
    <p>High-speed watercraft to explore distant islands.<br>Max speed 35 km/h Â· Controls: Joystick / WASD Â· [E] mount/dismount</p>
    <div style="background:rgba(255,255,255,.05);border-radius:8px;padding:10px;font-size:11px;color:#aaa;margin-bottom:12px;text-align:left;line-height:1.8;">
      ğŸï¸ <b style="color:#fff">Islands reachable by Jetski:</b><br>
      ğŸŸ¢ <b style="color:#2ecc71">Mystic Isle</b> â€” ~500m North-East<br>
      ğŸ”´ <b style="color:#e74c3c">Volcano Isle</b> â€” ~700m South-West<br>
      ğŸ”µ <b style="color:#00bcd4">Crystal Isle</b> â€” ~900m South
    </div>
    <button id="buyJetskiBtn" onclick="buyJetski()">Buy ğŸ’°1500</button>
  </div>
  <button onclick="closeJetskiShop()" style="padding:11px;background:rgba(255,255,255,.1);color:#fff;border:1px solid rgba(255,255,255,.2);border-radius:10px;cursor:pointer;font-size:13px;">âœ• Close</button>
</div>

<!-- MENU -->
<div id="menuUI">
  <h2>ğŸ£ Menu</h2>
  <button id="resumeBtn">â–¶ Resume</button>
  <button id="settingsBtn">ğŸ¨ Customize</button>
  <button id="saveBtn">ğŸ’¾ Save</button>
  <button id="quitBtn">ğŸšª Quit</button>
</div>
<div id="customUI">
  <h3>ğŸ¨ Customize</h3>
  <label>Shirt Color:</label>
  <input type="color" id="shirtColor" value="#2ecc71">
  <button id="saveCustom">ğŸ’¾ Save</button>
  <button id="closeCustomBtn">âœ• Close</button>
</div>

<style>
#harbourBtn{
  position:fixed;left:50%;bottom:230px;transform:translateX(-50%);
  background:linear-gradient(135deg,#e74c3c,#c0392b);
  color:#fff;border:none;border-radius:12px;
  padding:10px 22px;font-size:14px;font-weight:bold;
  cursor:pointer;z-index:20;display:none;
  box-shadow:0 4px 14px rgba(231,76,60,0.5);
}
#giftNotif{
  position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);
  background:linear-gradient(135deg,#f39c12,#e67e22);
  color:#fff;border-radius:18px;padding:20px 30px;
  font-size:16px;font-weight:bold;text-align:center;
  z-index:99998;display:none;
  box-shadow:0 8px 30px rgba(243,156,18,0.6);
  animation:giftPop 0.4s ease-out;
}
@keyframes giftPop{from{opacity:0;transform:translate(-50%,-50%) scale(0.5)}to{opacity:1;transform:translate(-50%,-50%) scale(1)}}
</style>
<div id="harbourBtn" onclick="jetskiSpawned?despawnJetski():spawnJetski()">ğŸ›¥ï¸ Spawn Jetski</div>
<div id="giftNotif"></div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="fish_textures.js" defer></script>
<script src="script.js" defer></script>
<script src="multiplayer.js" defer></script>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MAIN MENU SYSTEM
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let _menuGameMode = null; // 'single' | 'multi'
let _settingsPrevScreen = null;

// Generate bintang di background
function generateMenuStars() {
  const bg = document.getElementById("mainMenuBg");
  if (!bg) return;
  for (let i = 0; i < 60; i++) {
    const s = document.createElement("div");
    s.className = "menuStar";
    const size = 1 + Math.random() * 2.5;
    s.style.cssText = `width:${size}px;height:${size}px;left:${Math.random()*100}%;top:${Math.random()*100}%;animation-delay:${Math.random()*2}s;animation-duration:${1.5+Math.random()*2}s;`;
    bg.appendChild(s);
  }
}
generateMenuStars();

// Tampilkan main menu setelah loading selesai
function showMainMenuAfterLoad() {
  document.getElementById("mainMenu").classList.add("show");
  // Load saved player name
  const savedName = localStorage.getItem("playerName") || "";
  if (document.getElementById("playerNameInput")) document.getElementById("playerNameInput").value = savedName;
  if (document.getElementById("playerNameSet")) document.getElementById("playerNameSet").value = savedName;
  // Load shirt color
  const savedShirt = localStorage.getItem("playerShirt") || "#2ecc71";
  if (document.getElementById("shirtColor2")) document.getElementById("shirtColor2").value = savedShirt;
}

function hideAllMenus() {
  ["mainMenu","spMenu","mpMenu","settingsMenu"].forEach(id => {
    document.getElementById(id)?.classList.remove("show");
  });
}

function showMainMenu() {
  hideAllMenus();
  document.getElementById("mainMenu").classList.add("show");
}

// â”€â”€ SINGLEPLAYER â”€â”€
function showSPMenu() {
  hideAllMenus();
  document.getElementById("spMenu").classList.add("show");
  // Tampilkan info save
  const infoEl = document.getElementById("spSaveInfo");
  if (infoEl) {
    try {
      const d = JSON.parse(localStorage.getItem("fishingSave_v4"));
      if (d) infoEl.textContent = `Lv.${d.playerLevel||1} Â· ğŸ’°${d.coins||0} Â· ${(d.fish||[]).length} ikan`;
      else infoEl.textContent = "Belum ada save";
    } catch(e) { infoEl.textContent = "Belum ada save"; }
  }
}

function startNewGame() {
  if (!confirm("Mulai game baru? Progress yang belum disimpan akan hilang.")) return;
  localStorage.removeItem("fishingSave_v4");
  _menuGameMode = "single";
  startGame();
}

function loadSavedGame() {
  const d = localStorage.getItem("fishingSave_v4");
  if (!d) { alert("Belum ada save game!"); return; }
  _menuGameMode = "single";
  startGame();
}

// â”€â”€ MULTIPLAYER â”€â”€
function showMPMenu() {
  hideAllMenus();
  document.getElementById("mpMenu").classList.add("show");
  refreshRoomList();
}

function refreshRoomList() {
  const listEl = document.getElementById("mpRoomList");
  if (!listEl) return;
  listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:20px;">ğŸ”„ Memuat server...</div>';
  // Ambil room dari Firebase jika tersedia
  if (window.db) {
    window.db.ref("rooms").once("value", snap => {
      const rooms = snap.val() || {};
      const roomArr = Object.entries(rooms).filter(([k,v]) => v && v.name);
      if (roomArr.length === 0) {
        listEl.innerHTML = '<div style="text-align:center;color:#aaa;padding:20px;">Belum ada room. Buat yang pertama!</div>';
        return;
      }
      listEl.innerHTML = roomArr.map(([id, r]) => `
        <div class="roomCard">
          <div>
            <div class="roomName">ğŸï¸ ${r.name||id}</div>
            <div class="roomInfo">ğŸ‘¥ ${Object.keys(r.players||{}).length} pemain â€¢ ${r.weather||"Sunny"}</div>
          </div>
          <button class="roomJoin" onclick="joinRoom('${id}','${r.name||id}')">Masuk</button>
        </div>`).join("");
    });
  } else {
    listEl.innerHTML = '<div style="text-align:center;color:#e74c3c;padding:20px;">Firebase belum terhubung.<br><small>Setup Firebase di multiplayer.js</small></div>';
  }
}

function showCreateRoom() {
  const savedName = localStorage.getItem("playerName") || "";
  if (document.getElementById("playerNameInput")) document.getElementById("playerNameInput").value = savedName;
  document.getElementById("createRoomModal").classList.add("show");
}

function hideCreateRoom() {
  document.getElementById("createRoomModal").classList.remove("show");
}

function doCreateRoom() {
  const rName = document.getElementById("roomNameInput").value.trim();
  const pName = document.getElementById("playerNameInput").value.trim();
  if (!rName) { alert("Masukkan nama room!"); return; }
  if (!pName) { alert("Masukkan nama pemain!"); return; }
  localStorage.setItem("playerName", pName);
  localStorage.setItem("pendingRoomName", rName);
  localStorage.setItem("pendingRoomAction", "create");
  hideCreateRoom();
  _menuGameMode = "multi";
  startGame();
}

function joinRoom(id, name) {
  const pName = localStorage.getItem("playerName");
  if (!pName) {
    const n = prompt("Masukkan nama kamu:");
    if (!n) return;
    localStorage.setItem("playerName", n.trim());
  }
  localStorage.setItem("pendingRoomId", id);
  localStorage.setItem("pendingRoomAction", "join");
  _menuGameMode = "multi";
  startGame();
}

// â”€â”€ SETTINGS â”€â”€
function showSettingsMenu() {
  _settingsPrevScreen = "main";
  hideAllMenus();
  document.getElementById("settingsMenu").classList.add("show");
}

function settingsBack() {
  hideAllMenus();
  document.getElementById("mainMenu").classList.add("show");
}

function switchSetTab(tab, btn) {
  document.querySelectorAll(".setTabContent").forEach(el => el.style.display = "none");
  document.querySelectorAll(".setTab").forEach(el => el.classList.remove("active"));
  const el = document.getElementById("setTab_" + tab);
  if (el) el.style.display = "block";
  if (btn) btn.classList.add("active");
}

// Settings apply functions
function applyShirtColor(v) {
  localStorage.setItem("playerShirt", v);
  if (typeof setShirt === "function") setShirt(v);
  // Also sync to shirtColor input in-game
  const sc = document.getElementById("shirtColor");
  if (sc) sc.value = v;
}

function savePlayerName() {
  const name = document.getElementById("playerNameSet").value.trim();
  if (!name) { alert("Masukkan nama!"); return; }
  localStorage.setItem("playerName", name);
  alert("âœ… Nama disimpan: " + name);
}

function applyFog(v) {
  if (window.scene && window.scene.fog) window.scene.fog.density = parseFloat(v);
}

function applyWaterQuality(v) {
  // Placeholder â€” could adjust water geometry segments
}

function toggleShadow(el) {
  el.classList.toggle("on");
  if (window.renderer) window.renderer.shadowMap.enabled = el.classList.contains("on");
}

function applyPixelRatio(v) {
  if (window.renderer) window.renderer.setPixelRatio(Math.min(parseFloat(v), window.devicePixelRatio));
}

function applyMusicVol(v) {
  if (window.bgMusic) window.bgMusic.volume = parseFloat(v);
}

function applySFXVol(v) {
  [window.castSound, window.biteSound, window.catchSound].forEach(a => { if(a) a.volume = parseFloat(v); });
}

function toggleMute(el) {
  el.classList.toggle("on");
  const muted = !el.classList.contains("on");
  [window.bgMusic, window.castSound, window.biteSound, window.catchSound].forEach(a => { if(a) a.volume = muted ? 0 : 0.7; });
  if (window.bgMusic) window.bgMusic.volume = muted ? 0 : 0.35;
}

function applyJoySize(v) {
  const joy = document.getElementById("joystick");
  if (joy) { joy.style.width = v + "px"; joy.style.height = v + "px"; }
}

function toggleLandscape(el) {
  el.classList.toggle("on");
  if (el.classList.contains("on")) {
    if (screen.orientation && typeof screen.orientation.lock === "function") screen.orientation.lock("landscape").catch(()=>{});
  }
}

// â”€â”€ QUIT â”€â”€
function forceQuit() {
  if (confirm("Keluar dari game?")) {
    window.close();
    // Fallback jika window.close tidak bekerja di mobile
    document.body.innerHTML = '<div style="background:#000;color:#fff;display:flex;justify-content:center;align-items:center;height:100vh;font-size:18px;font-family:Arial">Tutup tab ini untuk keluar.</div>';
  }
}

// â”€â”€ START GAME (dari menu) â”€â”€
function startGame() {
  hideAllMenus();
  // Game sudah di-init, tinggal set mode
  window._gameMode = _menuGameMode;
  if (_menuGameMode === "single") {
    // Load save atau fresh start sudah ditangani sebelumnya
    if (typeof loadGameProgress === "function") loadGameProgress();
    gameStarted = true;
  } else if (_menuGameMode === "multi") {
    // Multiplayer.js akan handle room join/create via localStorage flags
    if (typeof loadGameProgress === "function") loadGameProgress();
    gameStarted = true;
    // Trigger MP init jika sudah loaded
    setTimeout(() => {
      if (window.MP && typeof window.MP.initFromMenu === "function") {
        window.MP.initFromMenu();
      }
    }, 500);
  }
}

// â”€â”€ BROADCAST NOTIFICATION â”€â”€
window.showBroadcastNotif = function(ownerName, message) {
  const el = document.getElementById("broadcastNotif");
  const ownerEl = document.getElementById("broadcastNotif")?.querySelector(".bcOwner");
  const msgEl = document.getElementById("broadcastMsg");
  if (!el || !msgEl) return;
  if (ownerEl) ownerEl.textContent = "ğŸ‘‘ OWNER Â· " + (ownerName || "Owner");
  msgEl.textContent = message;
  el.style.display = "block";
  el.style.animation = "none";
  void el.offsetWidth;
  el.style.animation = "xpFloat 0.4s ease-out";
  clearTimeout(el._t);
  el._t = setTimeout(() => { el.style.display = "none"; }, 5000);
};

// â”€â”€ HOOK LOADING COMPLETE â”€â”€
// Override simulateLoading setelah selesai untuk tampilkan main menu
const _origSimLoad = typeof simulateLoading !== "undefined" ? simulateLoading : null;
window.addEventListener("load", () => {
  // Tunggu game fully init, lalu tampilkan main menu
  setTimeout(showMainMenuAfterLoad, 2200);
  
  // gameStarted = false supaya player tidak bisa gerak di main menu
  // (gameStarted sudah false secara default, baru jadi true setelah startGame())
});
</script>
</body>
</html>
